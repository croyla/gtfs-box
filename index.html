<!DOCTYPE html>
<html lang="ja_JP" style="overscroll-behavior: none;">
<head>
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-MBWPV5QJ5S"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());
		gtag('config', 'G-MBWPV5QJ5S');
	</script>
	<meta charset="utf-8" />
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/fontawesome.css" />
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/brands.css" />
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/solid.css" />
	<link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" />
	<link rel="stylesheet" href="mini-tokyo-3d.min.css" />
	<link rel="stylesheet" href="gtfs-box.css" />
	<title>GTFS box</title>
	<meta name="description" content="A real-time 3D digital map of public transport systems with GTFS Realtime data." />
	<meta name="viewport" content="user-scalable=no, minimum-scale=1.0, maximum-scale=1.0, width=device-width, height=device-height, initial-scale=1" />
	<meta property="og:title" content="GTFS box" />
	<meta property="og:description" content="A real-time 3D digital map of public transport systems with GTFS Realtime data." />
	<meta property="og:locale" content="en_US" />
	<link rel="canonical" href="https://nagix.github.io/gtfs-box" />
	<meta property="og:url" content="https://nagix.github.io/gtfs-box" />
	<meta property="og:site_name" content="GTFS box" />
	<meta property="og:image" content="screenshot1.jpg" />
	<meta name="twitter:card" content="summary_large_image" />
	<meta name="twitter:site" content="@nagix" />
	<!-- Load MapLibre GL JS and create Mapbox GL JS compatibility shim -->
	<script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
	<script>
		// Create Mapbox GL JS compatibility layer for Mini Tokyo 3D
		window.mapboxgl = window.maplibregl;
		// Set a dummy accessToken to satisfy MT3D checks
		window.mapboxgl.accessToken = 'pk.maplibre';

		// Intercept fetch to mock Mapbox API responses
		const originalFetch = window.fetch;
		window.fetch = function(url, options) {
			// Mock Mapbox Tilequery API for timezone lookup
			if (typeof url === 'string' && url.includes('api.mapbox.com/v4/') && url.includes('/tilequery/')) {
				console.log('Intercepted Mapbox tilequery request, returning mock timezone data');
				// Return a mock timezone response (UTC+0)
				return Promise.resolve(new Response(JSON.stringify({
					type: 'FeatureCollection',
					features: [{
						type: 'Feature',
						geometry: { type: 'Point', coordinates: [0, 0] },
						properties: { TZID: 'UTC' }
					}]
				}), {
					status: 200,
					headers: { 'Content-Type': 'application/json' }
				}));
			}
			// Pass through all other requests
			return originalFetch.apply(this, arguments);
		};

		// Patch maplibregl.Map BEFORE MT3D loads to handle metadata access patterns
		(function() {
			const OriginalMap = maplibregl.Map;
			maplibregl.Map = function(options) {
				const map = new OriginalMap(options);

				// Store original methods
				const originalGetLayer = map.getLayer;
				const originalAddLayer = map.addLayer;
				const originalSetLayoutProperty = map.setLayoutProperty;
				const originalSetPaintProperty = map.setPaintProperty;

				// Wrap addLayer to ensure layers have metadata property
				map.addLayer = function(layer, beforeId) {
					// Ensure the layer object has a metadata property
					if (typeof layer === 'object' && layer !== null) {
						if (!layer.metadata) {
							layer.metadata = {};
						}
						// Make metadata writable if it's not
						Object.defineProperty(layer, 'metadata', {
							value: layer.metadata || {},
							writable: true,
							enumerable: true,
							configurable: true
						});
					}
					return originalAddLayer.call(this, layer, beforeId);
				};

				// Wrap getLayer to always return a valid object with metadata
				map.getLayer = function(id) {
					const layer = originalGetLayer.call(this, id);
					if (layer && !layer.metadata) {
						// Try to add metadata property
						try {
							layer.metadata = {};
						} catch (e) {
							// If we can't set it directly, define it as a property
							Object.defineProperty(layer, 'metadata', {
								value: {},
								writable: true,
								enumerable: true,
								configurable: true
							});
						}
					}
					return layer;
				};

				// Wrap setLayoutProperty to handle undefined layers gracefully
				map.setLayoutProperty = function(layerId, name, value) {
					try {
						const layer = this.getLayer(layerId);
						if (layer) {
							return originalSetLayoutProperty.call(this, layerId, name, value);
						}
					} catch (e) {
						console.warn(`Could not set layout property ${name} on layer ${layerId}:`, e);
					}
				};

				// Wrap setPaintProperty to handle undefined layers gracefully
				map.setPaintProperty = function(layerId, name, value) {
					try {
						const layer = this.getLayer(layerId);
						if (layer) {
							return originalSetPaintProperty.call(this, layerId, name, value);
						}
					} catch (e) {
						console.warn(`Could not set paint property ${name} on layer ${layerId}:`, e);
					}
				};

				return map;
			};

			// Copy static properties and prototype
			Object.setPrototypeOf(maplibregl.Map, OriginalMap);
			Object.setPrototypeOf(maplibregl.Map.prototype, OriginalMap.prototype);

			// Also apply to window.mapboxgl since MT3D uses that
			window.mapboxgl.Map = maplibregl.Map;
		})();
	</script>
	<script src="mini-tokyo-3d.min.js"></script>
	<!-- <script src="mt3d-plugin-precipitation.min.js"></script> -->
	<script src="mt3d-plugin-plateau.min.js"></script>
</head>
<body style="width: 100%; height: 100%; margin: 0; padding: 0; position: absolute; overscroll-behavior: none;">
	<div class="header">
		<div class="title">
			<div class="logo"><i class="fa-solid fa-bus"></i>GTFS box</div>
			<div class="github"><i id= "github" class="fa-brands fa-github"></i></div>
			<div class="toggle"><i id= "toggle" class="fa-solid fa-angle-down"></i></div>
		</div>
		<div id="config-container" class="config-container">
			<div class="config">
				<div class="form">
					<div><select id="select"></select></div>
					<div><input id="gtfs-url" placeholder="GTFS zip file URL"></div>
					<div><input id="gtfs-vp-url"placeholder="GTFS Realtime VehiclePosition URL"></div>
					<div class="position">
						<div><input id="color" type="color" value="#000099"></div>
						<div><input id="zoom" placeholder="Zoom"></div>
						<div><input id="latitude" placeholder="Latitude"></div>
						<div><input id="longitude" placeholder="Longitude"></div>
						<div><input id="bearing" placeholder="Bearing"></div>
						<div><input id="pitch" placeholder="Pitch"></div>
						<div id="location"><i class="fa-solid fa-location-crosshairs"></i></div>
					</div>
				</div>
				<div class="submit">
					<div id="load"><i class="fa-solid fa-rotate-right"></i></div>
				</div>
			</div>
		</div>
	</div>
	<div id="map" class="content"></div>
	<script src="gtfs-box.js"></script>
</body>
</html>
