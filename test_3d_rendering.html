<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>3D Rendering Test - GTFS Box</title>

    <!-- MapLibre GL JS -->
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.5.2/dist/maplibre-gl.css" />
    <script src="https://unpkg.com/maplibre-gl@4.5.2/dist/maplibre-gl.js"></script>

    <!-- Debug Panel -->
    <link rel="stylesheet" href="debug.css">
    <script src="debug.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        #test-info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            max-width: 400px;
            z-index: 1000;
            font-size: 13px;
        }
        #test-info h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
            color: #333;
        }
        #test-info button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px 5px 0 0;
            font-size: 12px;
        }
        #test-info button:hover {
            background: #0056b3;
        }
        #test-info button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .info-item {
            margin: 8px 0;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 12px;
        }
        .info-label {
            font-weight: 600;
            color: #495057;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="test-info">
        <h3>ðŸ§ª 3D Rendering Test</h3>
        <div class="info-item">
            <div class="info-label">Purpose:</div>
            Test MapLibre marker rendering without GTFS data
        </div>
        <div class="info-item">
            <div class="info-label">Test Steps:</div>
            1. Initialize MapLibre<br>
            2. Create vehicle markers with SVG icons<br>
            3. Render sample vehicles (10, 50, 100)<br>
            4. Monitor for freezes
        </div>
        <div>
            <button id="test-10">Add 10 Vehicles</button>
            <button id="test-50">Add 50 Vehicles</button>
            <button id="test-100">Add 100 Vehicles</button>
            <button id="clear">Clear All</button>
        </div>
    </div>

    <script>
        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize debug panel
            if (window.debugPanel) {
                window.debugPanel.log('INFO', 'ðŸ§ª 3D Rendering Test initialized');
                // Auto-open debug panel
                setTimeout(() => {
                    if (window.debugPanel && !window.debugPanel.isOpen) {
                        window.debugPanel.toggle();
                    }
                }, 100);
            }

            // Sample vehicle data generator
            function generateVehicles(count, center = [77.61, 12.95]) {
            if (window.debugPanel) {
                window.debugPanel.log('INFO', `Generating ${count} sample vehicles`, {
                    center,
                    timestamp: performance.now()
                });
            }

            const vehicles = [];
            const radius = 0.05; // ~5km spread

            for (let i = 0; i < count; i++) {
                // Random position around center
                const angle = Math.random() * 2 * Math.PI;
                const distance = Math.random() * radius;

                vehicles.push({
                    id: `vehicle_${i}`,
                    position: [
                        center[0] + Math.cos(angle) * distance,
                        center[1] + Math.sin(angle) * distance,
                        0 // altitude
                    ],
                    bearing: Math.random() * 360,
                    color: [
                        Math.floor(Math.random() * 255),
                        Math.floor(Math.random() * 255),
                        Math.floor(Math.random() * 255)
                    ],
                    speed: Math.random() * 60 // 0-60 km/h
                });
            }

            if (window.debugPanel) {
                window.debugPanel.log('INFO', `âœ… Generated ${count} vehicles`, {
                    sampleVehicle: vehicles[0]
                });
            }

            return vehicles;
        }

        // Initialize MapLibre map
        if (window.debugPanel) {
            window.debugPanel.log('INFO', 'Initializing MapLibre GL map');
        }

        const mapStartTime = performance.now();
        const map = new maplibregl.Map({
            container: 'map',
            style: 'assets/style.json',
            center: [77.61, 12.95],
            zoom: 12,
            pitch: 60,
            bearing: 0
        });

        const mapInitDuration = performance.now() - mapStartTime;
        if (window.debugPanel) {
            window.debugPanel.log('INFO', `Map initialized in ${mapInitDuration.toFixed(2)}ms`);
            window.debugPanel.recordPerformance('Map Initialization', mapInitDuration);
        }

        let currentVehicles = [];

        map.on('load', () => {
            if (window.debugPanel) {
                window.debugPanel.log('INFO', 'Map load event fired');
            }

            // Add navigation controls
            map.addControl(new maplibregl.NavigationControl());

            if (window.debugPanel) {
                window.debugPanel.log('INFO', 'Ready for vehicle marker tests');
            }
        });

        function createVehicleMarkers(vehicles) {
            if (window.debugPanel) {
                window.debugPanel.log('WARN', `ðŸŽ¨ Creating ${vehicles.length} MapLibre markers - may cause freeze`, {
                    vehicleCount: vehicles.length,
                    timestamp: performance.now()
                });
            }

            const startTime = performance.now();
            const markers = [];

            try {
                // Create SVG icon for each vehicle
                const createIconStartTime = performance.now();

                vehicles.forEach((vehicle, index) => {
                    // Create SVG element
                    const svg = `
                        <svg width="24" height="24" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="8" fill="rgb(${vehicle.color[0]},${vehicle.color[1]},${vehicle.color[2]})" stroke="white" stroke-width="2"/>
                            <line x1="12" y1="12" x2="12" y2="4" stroke="white" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    `;

                    const el = document.createElement('div');
                    el.innerHTML = svg;
                    el.style.width = '24px';
                    el.style.height = '24px';
                    el.style.transform = `rotate(${vehicle.bearing}deg)`;
                    el.style.cursor = 'pointer';
                    el.title = vehicle.id;

                    // Create marker
                    const marker = new maplibregl.Marker({ element: el, rotationAlignment: 'map' })
                        .setLngLat(vehicle.position)
                        .addTo(map);

                    markers.push(marker);
                });

                currentVehicles = markers;

                const createIconDuration = performance.now() - createIconStartTime;
                if (window.debugPanel) {
                    window.debugPanel.log('DEBUG', `Created ${vehicles.length} marker icons in ${createIconDuration.toFixed(2)}ms`);
                    window.debugPanel.recordPerformance('Marker Icon Creation', createIconDuration);
                }

                const totalDuration = performance.now() - startTime;
                if (window.debugPanel) {
                    window.debugPanel.recordPerformance('Total Marker Setup', totalDuration);

                    if (totalDuration > 100) {
                        window.debugPanel.log('ERROR', `âš ï¸ Marker setup took ${totalDuration.toFixed(2)}ms - FREEZE DETECTED`, {
                            totalDuration,
                            vehicleCount: vehicles.length
                        });
                    } else {
                        window.debugPanel.log('INFO', `âœ… Total marker setup: ${totalDuration.toFixed(2)}ms`);
                    }
                }

            } catch (error) {
                if (window.debugPanel) {
                    window.debugPanel.log('ERROR', 'Failed to create markers', {
                        error: error.message,
                        stack: error.stack
                    });
                }
                console.error('Marker creation error:', error);
            }
        }

        function clearMarkers() {
            if (window.debugPanel) {
                window.debugPanel.log('INFO', 'Clearing all markers');
            }

            try {
                currentVehicles.forEach(marker => marker.remove());
                currentVehicles = [];

                if (window.debugPanel) {
                    window.debugPanel.log('INFO', 'âœ… Markers cleared');
                }
            } catch (error) {
                if (window.debugPanel) {
                    window.debugPanel.log('ERROR', 'Failed to clear markers', {
                        error: error.message
                    });
                }
            }
        }

        // Button handlers
        document.getElementById('test-10').addEventListener('click', () => {
            if (window.debugPanel) {
                window.debugPanel.log('INFO', '===== TEST: 10 VEHICLES =====');
            }
            clearMarkers();
            const vehicles = generateVehicles(10);
            createVehicleMarkers(vehicles);
        });

        document.getElementById('test-50').addEventListener('click', () => {
            if (window.debugPanel) {
                window.debugPanel.log('INFO', '===== TEST: 50 VEHICLES =====');
            }
            clearMarkers();
            const vehicles = generateVehicles(50);
            createVehicleMarkers(vehicles);
        });

        document.getElementById('test-100').addEventListener('click', () => {
            if (window.debugPanel) {
                window.debugPanel.log('INFO', '===== TEST: 100 VEHICLES =====');
            }
            clearMarkers();
            const vehicles = generateVehicles(100);
            createVehicleMarkers(vehicles);
        });

        document.getElementById('clear').addEventListener('click', () => {
            if (window.debugPanel) {
                window.debugPanel.log('INFO', '===== CLEARING MARKERS =====');
            }
            clearMarkers();
        });

            // Monitor for errors
            window.addEventListener('error', (e) => {
                if (window.debugPanel) {
                    window.debugPanel.log('ERROR', 'Global error caught', {
                        message: e.message,
                        filename: e.filename,
                        lineno: e.lineno,
                        colno: e.colno
                    });
                }
            });
        }); // End of DOMContentLoaded
    </script>
</body>
</html>
