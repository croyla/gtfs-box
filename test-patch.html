<!DOCTYPE html>
<html>
<head>
	<title>Patch Test</title>
	<link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" />
	<style>
		body { margin: 0; padding: 20px; font-family: monospace; }
		#map { width: 100%; height: 400px; }
		#log { margin-top: 20px; padding: 10px; background: #f0f0f0; max-height: 300px; overflow-y: auto; }
		.success { color: green; }
		.error { color: red; }
	</style>
</head>
<body>
	<h1>MapLibre Patch Test</h1>
	<div id="map"></div>
	<div id="log"></div>

	<script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
	<script>
		const logEl = document.getElementById('log');
		function log(msg, isError = false) {
			const p = document.createElement('p');
			p.textContent = msg;
			p.className = isError ? 'error' : 'success';
			logEl.appendChild(p);
			console.log(msg);
		}

		log('[TEST] Starting patch test...');

		// Apply the same patches as index.html
		const OriginalMap = maplibregl.Map;
		maplibregl.Map = function(...args) {
			log('[PATCH] Map constructor intercepted');
			const map = new OriginalMap(...args);

			const patchStyle = () => {
				if (map.style && !map.style._mtglPatched) {
					log('[PATCH] Patching style.getOwnLayer');
					const style = map.style;
					const originalGetOwnLayer = style.getOwnLayer;

					style.getOwnLayer = function(id) {
						log('[PATCH] getOwnLayer called for: ' + id);
						let layer;

						if (typeof originalGetOwnLayer === 'function') {
							layer = originalGetOwnLayer.call(this, id);
							log('[PATCH] originalGetOwnLayer returned: ' + !!layer);
						}

						if (!layer && this._layers) {
							layer = this._layers[id];
							log('[PATCH] _layers returned: ' + !!layer);
						}

						if (!layer && typeof map.getLayer === 'function') {
							layer = map.getLayer(id);
							log('[PATCH] map.getLayer returned: ' + !!layer);
						}

						if (layer && !layer.hasOwnProperty('metadata')) {
							try {
								Object.defineProperty(layer, 'metadata', {
									value: {},
									writable: true,
									enumerable: true,
									configurable: true
								});
								log('[PATCH] Added metadata to: ' + id);
							} catch (e) {
								log('[PATCH] Failed to add metadata: ' + e.message, true);
							}
						}

						if (!layer) {
							log('[PATCH] Layer NOT found: ' + id, true);
						}

						return layer;
					};

					style._mtglPatched = true;
					log('[PATCH] Style patched successfully');
				}
			};

			setTimeout(patchStyle, 0);
			map.on('styledata', patchStyle);
			map.on('load', patchStyle);

			return map;
		};

		Object.setPrototypeOf(maplibregl.Map, OriginalMap);
		Object.setPrototypeOf(maplibregl.Map.prototype, OriginalMap.prototype);

		log('[TEST] Patches applied, creating map...');

		// Create a simple map
		const map = new maplibregl.Map({
			container: 'map',
			style: {
				version: 8,
				sources: {
					osm: {
						type: 'raster',
						tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
						tileSize: 256
					}
				},
				layers: [{
					id: 'osm',
					type: 'raster',
					source: 'osm'
				}]
			},
			center: [0, 0],
			zoom: 2
		});

		map.on('load', () => {
			log('[TEST] Map loaded');

			// Wait a bit for style to be ready
			setTimeout(() => {
				log('[TEST] Testing style.getOwnLayer...');

				// Test if style.getOwnLayer exists
				if (typeof map.style.getOwnLayer === 'function') {
					log('[TEST] style.getOwnLayer exists ✓');

					// Try to get the osm layer
					const layer = map.style.getOwnLayer('osm');
					if (layer) {
						log('[TEST] getOwnLayer("osm") returned layer ✓');

						// Try to set metadata
						try {
							layer.metadata = { test: 'value' };
							log('[TEST] Successfully set metadata ✓✓✓');
						} catch (e) {
							log('[TEST] Failed to set metadata: ' + e.message, true);
						}
					} else {
						log('[TEST] getOwnLayer("osm") returned undefined ✗', true);
					}
				} else {
					log('[TEST] style.getOwnLayer does NOT exist ✗', true);
				}
			}, 1000);
		});
	</script>
</body>
</html>
